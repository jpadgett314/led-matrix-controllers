const t=[50,172],e=Object.freeze([0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,4,4,4,4,4,4,5,5,5,5,6,6,6,6,6,7,7,7,7,8,8,8,9,9,9,10,10,10,11,11,11,12,12,12,13,13,14,14,14,15,15,16,16,17,17,17,18,18,19,19,20,20,21,22,22,23,23,24,24,25,26,26,27,27,28,29,29,30,31,32,32,33,34,34,35,36,37,38,38,39,40,41,42,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,66,67,68,69,70,71,73,74,75,76,78,79,80,82,83,84,86,87,88,90,91,93,94,96,97,99,100,102,103,105,106,108,110,111,113,115,116,118,120,121,123,125,127,128,130,132,134,136,138,140,141,143,145,147,149,151,153,155,157,159,161,164,166,168,170,172,174,177,179,181,183,186,188,190,193,195,197,200,202,205,207,210,212,215,217,220,222,225,228,230,233,236,238,241,244,247,249,252,255]),r=[],a=[{vendorId:12972,productId:32}];class i extends Error{constructor(){super("User cancelled device selection."),this.name=this.constructor.name,this.date=new Date}}class n{constructor(t){this.#t=t}async send(t,e){if(e.length<t.bytes)e=function(t,e,r=0){return t.concat(new Array(e-t.length).fill(r))}(e,t.bytes);else if(e.length>t.bytes)throw new Error("Unable to send report: too many bytes");const r=new Uint8Array(e).buffer;t.feature?await this.#t.sendFeatureReport(t.id,r):await this.#t.sendReport(t.buffer)}async receive(t){let e=[];if(!t.feature)throw new Error("Invalid operation");return e=await this.#t.receiveFeatureReport(t.id),e.byteLength!=t.bytes&&console.error(`reply length=${e.length} (exp ${t.bytes})`),e}#t}const o={id:1,bytes:32,feature:!0},s={id:4,bytes:306,feature:!0};class c{constructor(t){this.#e=t}async verifyFirmware(){try{const t=await this.info();return 34==t.display_height&&9==t.display_width}catch{return!1}}async version(){return{major:1,minor:0}}async draw(t){return await this.#e.send(s,t.flat().map(t=>e[Math.floor(255*(t??0))]))}async info(){const t=await this.#e.receive(o);return{sleep_pin:t.getUint8(1),dip1_pin:t.getUint8(2),intb_pin:t.getUint8(3),state_flags:t.getUint8(4),id_reg:t.getUint8(5),config_reg:t.getUint8(6),global_brightness:t.getUint8(7),display_width:t.getUint8(8),display_height:t.getUint8(9),timeout_ms:t.getUint32(10)}}#e}class l{static async make(t,e){if("web"===t){const t=await async function(){if(r&&r.length>0)return r.pop();if(r.push(...await navigator.hid.getDevices()),r&&r.length>0)return r.pop();if(r.push(...await navigator.hid.requestDevice({filters:a})),r&&r.length>0)return r.pop();throw new i}();if(t){if("sparkle"===e)return await l.makeSparkleController(t);throw new Error(`Unsupported firmware type: ${e}`)}return null}throw new Error(`Unsupported environment: ${t}`)}static async makeSparkleController(t){if(t)return await t.open(),new c(new n(t))}}class u{constructor(t){this.#r=`port-mutex-${Math.random().toString()}`,this.#a=new Map,this.#i=t}async acquire(t){const e=new Error("created bad cb").stack;await this.#n(async()=>{try{await t(this.#i)}catch(t){console.error("Error occured in anonymous callback."),console.error("Original error:",t),console.error("--- This callback was created at ---\n",e)}})}async acquireIdempotent(t,e){const r=new Error("created bad cb").stack;this.#a.has(t)&&console.info(`"${t}" request coalesced.`),this.#a.set(t,async()=>{try{await e(this.#i)}catch(t){console.error("Error occured in anonymous callback."),console.error("Original error:",t),console.error("--- This callback was created at ---\n",r)}}),await this.#n(()=>this.#o(t))}async#n(t){return navigator.locks.request(this.#r,t)}async#o(t){if(this.#a.has(t)){const e=this.#a.get(t);this.#a.delete(t),await e()}}#r;#a;#i}class h{constructor(t){this.#s=t}async rx(t,e=3e3){if(null===this.#s)throw new Error("attempted RX before port initialization.");if(this.#s.readable.locked)throw new Error("attempted RX while port locked.");const r=[],a=this.#s.readable.getReader(),i=setTimeout(()=>a.cancel(),e);try{for(;r.length<t;){const{value:t,done:e}=await a.read();if(r.push(...t??[]),e||!t)break}}finally{clearTimeout(i),a.releaseLock()}return r}async tx(t){if(null===this.#s)throw new Error("attempted TX before port initialization.");if(this.#s.writable.locked)throw new Error("attempted TX while port locked.");const e=this.#s.writable.getWriter();try{await e.write(new Uint8Array(t))}finally{await e.close()}}#s}class w extends Error{constructor(){super("User cancelled port selection."),this.name=this.constructor.name,this.date=new Date}}class d extends Error{constructor(){super("Selected port already in use."),this.name=this.constructor.name,this.date=new Date}}async function p(t){try{await t.close()}catch(t){if("InvalidStateError"!=t.name&&"Failed to execute 'close' on 'SerialPort': The port is already closed."!=t.message)throw t}}const f=Object.freeze({ANIMATE:4,BRIGHTNESS:0,BOOTLOADER:2,DRAW:6,DRAW_GREY_COL_BUFFER:8,GAME_CTRL:17,GAME_STATUS:18,PANIC:5,PATTERN:1,SLEEP:3,STAGE_GREY_COL:7,START_GAME:16,VERSION:32}),y=Object.freeze({GRAY_8BIT:{text:"8-bit Grayscale"},MONO_1BIT:{text:"1-bit Monochrome"}});let m=class{constructor(t){this.#c=y.MONO_1BIT,this.#l=t}async verifyFirmware(){let e=null;await this.#l.acquire(async r=>{await r.tx([...t,f.VERSION]),e=await r.rx(32)});const r=32==e.length,a=e.slice(3).every(t=>0==t);return r&&a}async version(){let e={};return await this.#l.acquire(async r=>{await r.tx([...t,f.VERSION]);const a=await r.rx(32);e.major=a[0],e.minor=a[1]>>4,e.patch=15&a[1],e.preRelease=1==a[2]}),e}async draw(e){if(this.#c==y.GRAY_8BIT){const t=Array.from({length:9},(t,r)=>new Array({length:34},(t,a)=>GAMMA[Math.floor(255*(e[a][r]??0))]));await this.#l.acquireIdempotent("drawMatrix",async e=>{for(let r=0;r<9;r++)await e.tx([f.STAGE_GREY_COL,r,...t[r]]);await e.tx([f.DRAW_GREY_COL_BUFFER])})}else if(this.#c==y.MONO_1BIT){let r=0,a=new Uint8Array(39).fill(0);for(let t=0;t<34;t++)for(let i=0;i<9;i++)e[t][i]&&(a[r>>3]|=1<<r%8),r++;await this.#l.acquireIdempotent("drawMatrix",async e=>{await e.tx([...t,f.DRAW,...a])})}}#c;#l};const E=Object.freeze({NOOP:0,ANIMATION_DIAMOND:100,ANIMATION_FIRE:98,ANIMATION_FIREPLACE:102,ANIMATION_GEAR:103,ANIMATION_RING:114,ANIMATION_STARTUP:97,ANIMATION_STARTUP_ONCE:65,BOOTLOADER:101,DRAW_PWM:109,DRAW_PWM_BLOCKING:77,DRAW_SCALE:110,DRAW_SCALE_BLOCKING:78,FLUSH_CMD_QUEUE:99,TEST_PATTERN:116,SET_CONST_PWM:119,SET_CONST_SCALE:115,SET_PX_PWM:112,SET_PX_SCALE:113,IDENT:127}),A=/^Sig\sFW\sLED\sMatrix\sFW\sV(\d+)\.(\d+)$/;class _{constructor(t){this.#l=t}async verifyFirmware(){let t=null;return await this.#l.acquire(async e=>{await e.tx([E.IDENT]),t=await e.rx(25)}),t=String.fromCharCode(...t),t.match(A)}async version(){let t=null;await this.#l.acquire(async e=>{await e.tx([E.IDENT]),t=await e.rx(25)}),t=String.fromCharCode(...t);const e=t.match(A);return e&&3==e.length?{major:e[1],minor:e[2]}:null}async draw(t){this.#u||(await this.#l.acquire(async t=>{await t.tx([E.SET_CONST_SCALE,32])}),this.#u=!0);const r=t.flat().map(t=>e[Math.floor(255*(t??0))]);await this.#l.acquireIdempotent("drawMatrix",async t=>{await t.tx([E.DRAW_PWM,...r])})}#l;#u}class b{static async make(t,e){if("web"===t){const t=await async function(){try{const t=await navigator.serial.requestPort(),{usbProductId:e,usbVendorId:r}=t;return console.log("Selected port:",t),e&&r&&console.log(`VID:PID ${r}:${e}`),t}catch(t){throw"NotFoundError"==t.name?new w:"InvalidStateError"==t.name?new d:t}}();if(t){if("framework-official"===e)return await b.makeDefaultWebController(t);if("sigroot"===e)return await b.makeSigrootWebController(t);if("auto"===e)return await b.makeAutoWebController(t);throw new Error(`Unsupported firmware type: ${e}`)}return null}throw new Error(`Unsupported environment: ${t}`)}static async makeDefaultWebController(t){if(t?.connected)return await p(t),await t.open({baudRate:115200}),new m(new u(new h(t)))}static async makeSigrootWebController(t){if(t?.connected)return await p(t),await t.open({baudRate:115200}),new _(new u(new h(t)))}static async makeAutoWebController(t){const e=await this.makeDefaultWebController(t);if(await e.verifyFirmware())return e;const r=await this.makeSigrootWebController(t);return await r.verifyFirmware()?r:void 0}}export{l as HIDControllerFactory,b as SerialControllerFactory};
//# sourceMappingURL=led-matrix-controllers.browser.mjs.map
