const t=9,e=34,r=12972,a=[50,172],i=32,n=[0,32],s=Object.freeze([0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,4,4,4,4,4,4,5,5,5,5,6,6,6,6,6,7,7,7,7,8,8,8,9,9,9,10,10,10,11,11,11,12,12,12,13,13,14,14,14,15,15,16,16,17,17,17,18,18,19,19,20,20,21,22,22,23,23,24,24,25,26,26,27,27,28,29,29,30,31,32,32,33,34,34,35,36,37,38,38,39,40,41,42,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,66,67,68,69,70,71,73,74,75,76,78,79,80,82,83,84,86,87,88,90,91,93,94,96,97,99,100,102,103,105,106,108,110,111,113,115,116,118,120,121,123,125,127,128,130,132,134,136,138,140,141,143,145,147,149,151,153,155,157,159,161,164,166,168,170,172,174,177,179,181,183,186,188,190,193,195,197,200,202,205,207,210,212,215,217,220,222,225,228,230,233,236,238,241,244,247,249,252,255]),o=[],c=[{vendorId:12972,productId:32}];class l extends Error{constructor(){super("User cancelled device selection."),this.name=this.constructor.name,this.date=new Date}}class d{constructor(t){this.#t=t}async send(t,e){if(e.length<t.bytes)e=function(t,e,r=0){return t.concat(new Array(e-t.length).fill(r))}(e,t.bytes);else if(e.length>t.bytes)throw new Error("Unable to send report: too many bytes");const r=new Uint8Array(e).buffer;t.feature?await this.#t.sendFeatureReport(t.id,r):await this.#t.sendReport(t.buffer)}async receive(t){let e=[];if(!t.feature)throw new Error("Invalid operation");return e=await this.#t.receiveFeatureReport(t.id),e.byteLength!=t.bytes&&console.error(`reply length=${e.byteLength} (exp ${t.bytes})`),e}#t}const h={id:1,bytes:307,feature:!0},w={id:2,bytes:16,feature:!0},u={id:4,bytes:306,feature:!0},p=0,y=1,f=2,m=3,A=5;class E{constructor(t){this.#e=t}async info(){const t=await this.#e.receive(h);return{sleep_pin:t.getUint8(1),dip1_pin:t.getUint8(2),intb_pin:t.getUint8(3),state_flags:t.getUint8(4),id_reg:t.getUint8(5),config_reg:t.getUint8(6),global_brightness:t.getUint8(7),display_width:t.getUint8(8),display_height:t.getUint8(9),timeout_ms:t.getUint32(10)}}async wake(){await this.#e.send(w,[y,!1])}async sleep(){await this.#e.send(w,[y,!0])}async disableSleep(){await this.#e.send(w,[m,255,255,255,255])}async disableDeepSleep(){await this.#e.send(w,[f,1])}async disableSleepTimer(){await this.#e.send(w,[m,0,0,0,0])}async enableDeepSleep(){await this.#e.send(w,[f,0])}async enableSleepTimer(t){const e=new DataView(new ArrayBuffer(4));e.setInt32(0,t,!1),await this.#e.send(w,[m,e.getUint8(0),e.getUint8(1),e.getUint8(2),e.getUint8(3)])}async reboot(t){await this.#e.send(w,[p,t])}async drawPixel(t,e,r){await this.#e.send(w,[A,e,t,r])}async drawLine({r1:t,c1:e},{r2:r,c2:a},i){await this.#e.send(w,[A,t,e,r,a,i])}async verifyFirmware(){try{const t=await this.info();return 34==t.display_height&&9==t.display_width}catch{return!1}}async version(){return{major:1,minor:0}}async draw(t){return await this.#e.send(u,t.flat().map(t=>s[Math.floor(255*(t??0))]))}#e}class O{static async make(t){const e=await async function(){if(o&&o.length>0)return o.pop();if(o.push(...await navigator.hid.getDevices()),o&&o.length>0)return o.pop();if(o.push(...await navigator.hid.requestDevice({filters:c})),o&&o.length>0)return o.pop();throw new l}();if(e){if("sparkle"===t)return await O.makeSparkleController(e);throw new Error(`Unsupported firmware type: ${t}`)}return null}static async makeSparkleController(t){if(t)return await t.open(),new E(new d(t))}}class b{constructor(t){this.#r=`port-mutex-${Math.random().toString()}`,this.#a=new Map,this.#i=t}async acquire(t){const e=new Error("created bad cb").stack;await this.#n(async()=>{try{await t(this.#i)}catch(t){console.error("Error occured in anonymous callback."),console.error("Original error:",t),console.error("--- This callback was created at ---\n",e)}})}async acquireIdempotent(t,e){const r=new Error("created bad cb").stack;this.#a.has(t)&&console.info(`"${t}" request coalesced.`),this.#a.set(t,async()=>{try{await e(this.#i)}catch(t){console.error("Error occured in anonymous callback."),console.error("Original error:",t),console.error("--- This callback was created at ---\n",r)}}),await this.#n(()=>this.#s(t))}async#n(t){return navigator.locks.request(this.#r,t)}async#s(t){if(this.#a.has(t)){const e=this.#a.get(t);this.#a.delete(t),await e()}}#r;#a;#i}class _{constructor(t){this.#o=t}async rx(t,e=3e3){if(null===this.#o)throw new Error("attempted RX before port initialization.");if(this.#o.readable.locked)throw new Error("attempted RX while port locked.");const r=[],a=this.#o.readable.getReader(),i=setTimeout(()=>a.cancel(),e);try{for(;r.length<t;){const{value:t,done:e}=await a.read();if(r.push(...t??[]),e||!t)break}}finally{clearTimeout(i),a.releaseLock()}return r}async tx(t){if(null===this.#o)throw new Error("attempted TX before port initialization.");if(this.#o.writable.locked)throw new Error("attempted TX while port locked.");const e=this.#o.writable.getWriter();try{await e.write(new Uint8Array(t))}finally{await e.close()}}#o}class g extends Error{constructor(){super("User cancelled port selection."),this.name=this.constructor.name,this.date=new Date}}class T extends Error{constructor(){super("Selected port already in use."),this.name=this.constructor.name,this.date=new Date}}async function I(t){try{await t.close()}catch(t){if("InvalidStateError"!=t.name&&"Failed to execute 'close' on 'SerialPort': The port is already closed."!=t.message)throw t}}const S=Object.freeze({ANIMATE:4,BRIGHTNESS:0,BOOTLOADER:2,DRAW:6,DRAW_GREY_COL_BUFFER:8,GAME_CTRL:17,GAME_STATUS:18,PANIC:5,PATTERN:1,SLEEP:3,STAGE_GREY_COL:7,START_GAME:16,VERSION:32}),M=Object.freeze({GRAY_8BIT:"8-bit",MONO_1BIT:"1-bit"});class R{constructor(t){this.#c=M.MONO_1BIT,this.#l=t}async verifyFirmware(){let t=null;await this.#l.acquire(async e=>{await e.tx([...a,S.VERSION]),t=await e.rx(32)});const e=32==t.length,r=t.slice(3).every(t=>0==t);return e&&r}async version(){let t={};return await this.#l.acquire(async e=>{await e.tx([...a,S.VERSION]);const r=await e.rx(32);t.major=r[0],t.minor=r[1]>>4,t.patch=15&r[1],t.preRelease=1==r[2]}),t}async draw(t){if(this.#c==M.GRAY_8BIT){const e=Array.from({length:9},(e,r)=>new Array({length:34},(e,a)=>GAMMA[Math.floor(255*(t[a][r]??0))]));await this.#l.acquireIdempotent("drawMatrix",async t=>{for(let r=0;r<9;r++)await t.tx([S.STAGE_GREY_COL,r,...e[r]]);await t.tx([S.DRAW_GREY_COL_BUFFER])})}else if(this.#c==M.MONO_1BIT){let e=0,r=new Uint8Array(39).fill(0);for(let a=0;a<34;a++)for(let i=0;i<9;i++)t[a][i]&&(r[e>>3]|=1<<e%8),e++;await this.#l.acquireIdempotent("drawMatrix",async t=>{await t.tx([...a,S.DRAW,...r])})}}#c;#l}const x=Object.freeze({NOOP:0,ANIMATION_DIAMOND:100,ANIMATION_FIRE:98,ANIMATION_FIREPLACE:102,ANIMATION_GEAR:103,ANIMATION_RING:114,ANIMATION_STARTUP:97,ANIMATION_STARTUP_ONCE:65,BOOTLOADER:101,DRAW_PWM:109,DRAW_PWM_BLOCKING:77,DRAW_SCALE:110,DRAW_SCALE_BLOCKING:78,FLUSH_CMD_QUEUE:99,TEST_PATTERN:116,SET_CONST_PWM:119,SET_CONST_SCALE:115,SET_PX_PWM:112,SET_PX_SCALE:113,IDENT:127}),N=/^Sig\sFW\sLED\sMatrix\sFW\sV(\d+)\.(\d+)$/;class D{constructor(t){this.#l=t}async verifyFirmware(){let t=null;return await this.#l.acquire(async e=>{await e.tx([x.IDENT]),t=await e.rx(25)}),t=String.fromCharCode(...t),t.match(N)}async version(){let t=null;await this.#l.acquire(async e=>{await e.tx([x.IDENT]),t=await e.rx(25)}),t=String.fromCharCode(...t);const e=t.match(N);return e&&3==e.length?{major:e[1],minor:e[2]}:null}async draw(t){this.#d||(await this.#l.acquire(async t=>{await t.tx([x.SET_CONST_SCALE,32])}),this.#d=!0);const e=t.flat().map(t=>s[Math.floor(255*(t??0))]);await this.#l.acquireIdempotent("drawMatrix",async t=>{await t.tx([x.DRAW_PWM,...e])})}#l;#d}class k{static async make(t){const e=await async function(){try{const t=await navigator.serial.requestPort(),{usbProductId:e,usbVendorId:r}=t;return console.log("Selected port:",t),e&&r&&console.log(`VID:PID ${r}:${e}`),t}catch(t){throw"NotFoundError"==t.name?new g:"InvalidStateError"==t.name?new T:t}}();if(e){if("framework-official"===t)return await k.makeDefaultWebController(e);if("sigroot"===t)return await k.makeSigrootWebController(e);if("auto"===t)return await k.makeAutoWebController(e);throw new Error(`Unsupported firmware type: ${t}`)}}static async makeDefaultWebController(t){if(t?.connected)return await I(t),await t.open({baudRate:115200}),new R(new b(new _(t)))}static async makeSigrootWebController(t){if(t?.connected)return await I(t),await t.open({baudRate:115200}),new D(new b(new _(t)))}static async makeAutoWebController(t){const e=await this.makeDefaultWebController(t);if(await e.verifyFirmware())return e;const r=await this.makeSigrootWebController(t);return await r.verifyFirmware()?r:void 0}}export{s as GAMMA,e as HEIGHT,O as HIDControllerFactory,i as PID,n as PID_ARR,k as SerialControllerFactory,r as VID,a as VID_ARR,t as WIDTH};
//# sourceMappingURL=led-matrix-controllers.browser.mjs.map
